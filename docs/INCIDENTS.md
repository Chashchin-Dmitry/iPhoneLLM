# Журнал инцидентов и решений

## Обзор
Этот документ содержит все проблемы, с которыми мы столкнулись при разработке LocalChat, и их решения.

---

## Инцидент #1: Ошибка "No such module 'LLM'"

### Описание
После добавления Swift Package `LLM.swift` через File → Add Package Dependencies, проект не компилируется с ошибкой:
```
No such module 'LLM'
```

### Причина
Swift Package был добавлен в проект, но **не подключен к target** приложения. Xcode добавляет пакет на уровне проекта, но не всегда автоматически линкует его с target.

### Симптомы
- Пакет виден в левой панели под "Package Dependencies"
- Файл `Package.resolved` существует
- При сборке (Cmd+B) ошибка "No such module 'LLM'"

### Решение
**Способ 1: Через Build Phases (рекомендуется)**
1. Нажать на проект LocalChat (синяя иконка)
2. Выбрать Targets → LocalChat
3. Перейти на вкладку **Build Phases**
4. Раскрыть секцию **"Link Binary With Libraries"**
5. Нажать **+**
6. Найти **LLM** (под LLM Package)
7. Нажать **Add**
8. Пересобрать проект (Cmd+B)

**Способ 2: Через General**
1. Targets → LocalChat → General
2. Прокрутить вниз до "Frameworks, Libraries, and Embedded Content"
3. Нажать **+**
4. Добавить **LLM**

### Профилактика
При добавлении нового Swift Package всегда проверять:
- Галочка "Add to Target: LocalChat" стоит в диалоге добавления
- Пакет появился в Build Phases → Link Binary With Libraries

---

## Инцидент #2: Ошибка "Signing requires a development team"

### Описание
При попытке запуска на iPhone появляется ошибка:
```
Signing for "LocalChat" requires a development team.
Select a development team in the Signing & Capabilities editor.
```

### Причина
Не настроена подпись приложения — не выбран Team (Apple ID).

### Решение
1. LocalChat (проект) → Targets → LocalChat
2. Вкладка **Signing & Capabilities**
3. Поставить галочку **"Automatically manage signing"**
4. В поле **Team** выбрать свой Apple ID (Personal Team)

### Примечания
- Бесплатный Apple ID подходит для разработки
- Приложения с бесплатным Apple ID нужно переустанавливать каждые 7 дней

---

## Инцидент #3: iPhone не отображается в Xcode

### Описание
iPhone подключен кабелем, но в списке устройств показывает:
```
Waiting to reconnect to iPhone (название)
```
или iPhone вообще не виден.

### Причины
1. iPhone заблокирован
2. Не подтверждено доверие компьютеру
3. Проблема с кабелем
4. Устаревшая версия iOS/Xcode

### Решение
1. **Разблокировать iPhone**
2. При запросе "Доверять этому компьютеру?" → **Доверять**
3. Отключить и подключить кабель заново
4. Попробовать другой USB-порт
5. В Xcode: **Window → Devices and Simulators** — проверить статус
6. Перезапустить Xcode

### Проверка совместимости
| Xcode | Минимальная iOS | Максимальная iOS |
|-------|-----------------|------------------|
| 16.0 | iOS 12 | iOS 18.2 |
| 15.4 | iOS 12 | iOS 17.5 |

---

## Инцидент #4: "Untrusted Developer" на iPhone

### Описание
После установки приложения на iPhone, при попытке запуска появляется:
```
Untrusted Developer
Ненадёжный разработчик
```

### Причина
iOS не доверяет приложениям от неизвестных разработчиков (Personal Team).

### Решение
На iPhone:
1. **Настройки** → **Основные**
2. **VPN и управление устройством** (или "Профили и управление устройством")
3. Найти свой Apple ID / email разработчика
4. Нажать на него
5. Нажать **"Доверять"**
6. Подтвердить

После этого приложение запустится.

---

## Инцидент #5: Модель не найдена в Bundle

### Описание
Приложение запускается, но показывает:
```
Модель не найдена в Bundle!
```

### Причина
Файл `.gguf` не добавлен в target приложения.

### Решение
1. В левой панели Xcode выбрать файл `.gguf`
2. В правой панели (File Inspector, иконка документа)
3. Секция **Target Membership**
4. Поставить галочку напротив **LocalChat**

### Проверка
Проверить что файл включён в сборку:
1. Targets → LocalChat → Build Phases
2. Copy Bundle Resources
3. Файл `.gguf` должен быть в списке

---

## Инцидент #6: Приложение вылетает при загрузке модели

### Описание
Приложение запускается, показывает экран загрузки, затем вылетает без сообщения об ошибке.

### Причина
Недостаточно оперативной памяти на устройстве для загрузки модели.

### Решение

**Вариант 1: Освободить память**
- Закрыть все приложения на iPhone
- Перезагрузить iPhone

**Вариант 2: Запросить больше памяти**
Добавить в Info.plist:
```xml
<key>com.apple.developer.kernel.increased-memory-limit</key>
<true/>
```

**Вариант 3: Использовать меньшую модель**
- Q4_K_S вместо Q4_K_M (экономия ~200 МБ)
- Llama 3.2 1B вместо Gemma 2B

### Требования к памяти
| Модель | Размер файла | RAM для работы |
|--------|--------------|----------------|
| Gemma 2B Q4_K_S | 1.3 ГБ | ~3 ГБ |
| Gemma 2B Q4_K_M | 1.5 ГБ | ~4 ГБ |
| Phi-3 Mini Q4 | 2.2 ГБ | ~5 ГБ |

---

## Инцидент #7: Xcode показывает "Add items" вместо меню проекта

### Описание
При нажатии + в разных местах Xcode открываются неправильные меню.

### Частые ошибки
- Нажатие + внизу левой панели → добавление файлов/папок
- Нажатие + в Targets → создание нового target (Framework, App Extension)
- Нажатие + в Capabilities → добавление возможностей (Push, iCloud)

### Правильные действия

| Задача | Где нажимать |
|--------|--------------|
| Добавить Swift файл | Правый клик на папке → New File |
| Добавить пакет | File → Add Package Dependencies |
| Добавить framework | Build Phases → Link Binary → + |
| Добавить файл в сборку | Build Phases → Copy Bundle Resources → + |

---

## Инцидент #8: Ошибки при добавлении пакета

### Описание
При добавлении LLM.swift появляется сообщение:
```
The project "LocalChat" already depends on: "llm.swift"
```

### Причина
Пакет уже был добавлен ранее.

### Решение
1. Нажать **Cancel**
2. Проверить что пакет виден в Package Dependencies (левая панель)
3. Подключить к target через Build Phases (см. Инцидент #1)

---

## Инцидент #9: Медленная генерация текста

### Описание
Модель отвечает очень медленно (1-2 токена в секунду).

### Причина
- Большая модель для устройства
- Много фоновых процессов
- Перегрев устройства

### Решение
1. **Использовать меньшую модель** — Llama 3.2 1B работает в 2-3 раза быстрее
2. **Ограничить количество токенов** — параметр `maxTokenCount` в инициализации LLM
3. **Охладить устройство** — подождать если iPhone горячий

### Ожидаемая производительность
| Устройство | Gemma 2B Q4 | Llama 1B Q4 |
|------------|-------------|-------------|
| iPhone 12 | 5-8 tok/s | 15-20 tok/s |
| iPhone 14 | 10-15 tok/s | 25-35 tok/s |
| iPhone 15 Pro | 20-30 tok/s | 40-50 tok/s |

---

## Инцидент #10: Файлы не появляются в Xcode

### Описание
Файлы созданы в папке проекта (через Finder или терминал), но не видны в Xcode.

### Причина
В Xcode 16+ используется File System Synchronized Groups — файлы должны появляться автоматически, но иногда требуется обновление.

### Решение
1. **Cmd+Shift+K** — Clean Build Folder
2. Закрыть и открыть Xcode
3. Правый клик на папке → **Add Files to "LocalChat"**
4. Выбрать файлы → Add

### Проверка синхронизации
В project.pbxproj должно быть:
```
PBXFileSystemSynchronizedRootGroup
```
Это означает автоматическую синхронизацию с файловой системой.

---

## Чеклист перед релизом

### Перед каждым запуском
- [ ] iPhone подключен и разблокирован
- [ ] Выбран iPhone (не симулятор) в списке устройств
- [ ] Team выбран в Signing & Capabilities
- [ ] Нет ошибок компиляции (Cmd+B)

### Перед демонстрацией
- [ ] Модель загружается без ошибок
- [ ] Приложение отвечает на вопросы
- [ ] Достаточно заряда на iPhone
- [ ] Закрыты лишние приложения

---

## Инцидент #11: Developer Mode disabled

### Описание
При попытке запуска на iPhone появляется ошибка:
```
Developer Mode disabled
To use iPhone (название) for development, enable Developer Mode in Settings → Privacy & Security.
Code: -28
```

### Причина
Начиная с iOS 16, Apple требует включения режима разработчика для установки приложений через Xcode.

### Решение
На iPhone:
1. **Настройки** → **Конфиденциальность и безопасность** (Privacy & Security)
2. Прокрутить вниз до конца
3. Найти **Режим разработчика** (Developer Mode)
4. **Включить** переключатель
5. Появится предупреждение — нажать **Перезагрузить**
6. После перезагрузки появится запрос — нажать **Включить**
7. Ввести пароль iPhone если попросит

### После включения
1. Вернуться в Xcode
2. Нажать **Cmd+R** (Run)
3. Приложение установится и запустится

### Примечания
- Developer Mode остаётся включённым пока не выключите вручную
- Это требование безопасности Apple
- На iOS 15 и ниже этот шаг не нужен

---

## Контакты для эскалации

При нерешаемых проблемах:
- **LLM.swift issues:** https://github.com/eastriverlee/LLM.swift/issues
- **Apple Developer Forums:** https://developer.apple.com/forums/
- **Stack Overflow:** тег `[swiftui]` или `[llm]`

---

*Последнее обновление: 2025-12-15*
